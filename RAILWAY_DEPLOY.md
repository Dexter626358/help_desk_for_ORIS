# Инструкция по деплою на Railway

Это руководство поможет вам развернуть IPSAS на Railway.

## Подготовка проекта

Проект уже содержит все необходимые файлы для деплоя:
- `Procfile` - команда запуска для Railway
- `runtime.txt` - версия Python
- `requirements.txt` - зависимости проекта

## Шаги деплоя

### 1. Создание проекта на Railway

1. Зайдите на [railway.app](https://railway.app)
2. Войдите в аккаунт (или создайте новый)
3. Нажмите "New Project"
4. Выберите "Deploy from GitHub repo" (если проект в GitHub) или "Empty Project"

### 2. Подключение репозитория

Если используете GitHub:
1. Выберите ваш репозиторий
2. Railway автоматически определит Python проект
3. Нажмите "Deploy"

Если загружаете вручную:
1. Выберите "Empty Project"
2. Установите Railway CLI: `npm i -g @railway/cli`
3. Выполните `railway login` и `railway init`
4. Загрузите файлы проекта

### 3. Настройка переменных окружения

В настройках проекта (Settings → Variables) добавьте:

**ОБЯЗАТЕЛЬНЫЕ:**
```
SECRET_KEY=<сгенерируйте случайную строку>
```

**ОПЦИОНАЛЬНЫЕ:**
```
LOG_LEVEL=INFO
MAX_FILE_SIZE=10485760
```

**Для PostgreSQL (рекомендуется для production):**
1. Добавьте PostgreSQL сервис в проект
2. Railway автоматически создаст переменную `DATABASE_URL`
3. В настройках проекта добавьте:
```
DATABASE_URI=${{Postgres.DATABASE_URL}}
```

### 4. Настройка базы данных

**Вариант 1: SQLite (для тестирования)**
- SQLite будет работать, но данные могут теряться при перезапуске
- Не рекомендуется для production

**Вариант 2: PostgreSQL (рекомендуется)**
1. В Railway добавьте PostgreSQL сервис
2. В переменных окружения установите:
   ```
   DATABASE_URI=${{Postgres.DATABASE_URL}}
   ```
3. При первом запуске база данных инициализируется автоматически

### 5. Инициализация базы данных

После первого деплоя:
1. Откройте приложение
2. Зарегистрируйте первого пользователя через веб-интерфейс
3. Или используйте Railway CLI для выполнения команд:
   ```bash
   railway run python -c "from ipsas.web.app import create_app; from ipsas.models.user import init_db; app = create_app(); init_db(app)"
   ```

### 6. Настройка домена

1. В настройках проекта перейдите в "Settings" → "Networking"
2. Нажмите "Generate Domain" для получения бесплатного домена
3. Или добавьте свой кастомный домен

## Проверка деплоя

После деплоя проверьте:
- ✅ Приложение доступно по URL
- ✅ Страница входа открывается
- ✅ Можно зарегистрировать пользователя
- ✅ Все сервисы работают

## Мониторинг

Railway предоставляет:
- Логи в реальном времени
- Метрики использования ресурсов
- История деплоев

## Обновление приложения

При каждом push в репозиторий Railway автоматически:
1. Обнаруживает изменения
2. Собирает проект
3. Деплоит новую версию

## Устранение проблем

### Ошибка: "Module not found"
- Проверьте, что все зависимости в `requirements.txt`
- Убедитесь, что `runtime.txt` указывает правильную версию Python

### Ошибка: "Port already in use"
- Railway автоматически устанавливает переменную `PORT`
- Убедитесь, что `Procfile` использует `$PORT`

### Ошибка базы данных
- Проверьте переменную `DATABASE_URI`
- Убедитесь, что PostgreSQL сервис запущен (если используется)

### Файлы не сохраняются
- Временные файлы хранятся в `/tmp` на Railway
- Файлы удаляются при перезапуске контейнера
- Для постоянного хранения используйте внешнее хранилище (S3, Railway Volumes)

## Дополнительные настройки

### Увеличение таймаута
Если обработка файлов занимает много времени, в `Procfile` можно увеличить `--timeout`:
```
web: python -m gunicorn run:app --bind 0.0.0.0:$PORT --workers 2 --threads 2 --timeout 300
```

### Увеличение размера файлов
В переменных окружения установите:
```
MAX_FILE_SIZE=52428800  # 50MB
```

## Безопасность

⚠️ **ВАЖНО:**
- Никогда не коммитьте `.env` файл в репозиторий
- Используйте сильный `SECRET_KEY` в production
- Регулярно обновляйте зависимости
- Используйте PostgreSQL вместо SQLite для production

## Поддержка

При возникновении проблем:
1. Проверьте логи в Railway Dashboard
2. Убедитесь, что все переменные окружения установлены
3. Проверьте, что `Procfile` и `requirements.txt` корректны
